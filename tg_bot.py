from aiogram import Bot, Dispatcher, executor, filters, types
from dotenv import load_dotenv

import os
from database import DataBasePostgres
import buttons as btn


load_dotenv()

bot = Bot(os.getenv("TOKEN"))
dp = Dispatcher(bot)

bd = DataBasePostgres()

quiz_data = {
    "–ú–∞—Ä—Å–µ–ª—å—Å–∫–æ–µ —Ç–∞—Ä–æ –∏ —Ç–∞—Ä–æ –†–∞–π–¥–µ—Ä–∞ –£—ç–π—Ç–∞ - —ç—Ç–æ –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Å–∏—Å—Ç–µ–º–∞?": [
        "–í–µ—Ä–Ω–æ", "–ù–µ –≤–µ—Ä–Ω–æ"
    ],
    "–ö–∞–∫–æ–π –∏–∑ –ê—Ä–∫–∞–Ω–æ–≤ –ø—Ä–µ–¥–≤–µ—â–∞–µ—Ç —Å–∫–æ—Ä–æ–µ –∑–∞–º—É–∂–µ—Å—Ç–≤–æ?": [
        "–ü—Ä—è–º–∞—è –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –∫—É–±–∫–æ–≤"
    ],
    "–°–æ—Å—Ç–æ–∏—Ç—Å—è –ª–∏ —Å–≤–∞–¥—å–±–∞ –ø–æ —á–µ—Ç–≤—ë—Ä–∫–µ –∂–µ–∑–ª–æ–≤?": [
        "–î–∞", "–ù–µ—Ç", "–°–æ—Å—Ç–æ–∏—Ç—Å—è, –Ω–æ –Ω–µ —Å–∫–æ—Ä–æ"
    ],
    "–ö–∞–∫–æ–π –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ê—Ä–∫–∞–Ω–æ–≤ –≥–æ–≤–æ—Ä–∏—Ç –æ –º—É–¥—Ä–æ—Å—Ç–∏?": [
        "–î–µ—Å—è—Ç–∫–∞ –∫—É–±–∫–æ–≤", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã"
    ],
    "–ù–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ –¥–æ—Ä–æ–≥–µ —É–∫–∞–∂–µ—Ç —Å–≤—è–∑–∫–∞ –ê—Ä–∫–∞–Ω–æ–≤:": [
        "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä + —Ç—É–∑ –∂–µ–∑–ª–æ–≤", "–í–æ—Å–µ–º—å –∫—É–±–∫–æ–≤ + —Ç—É–∑ –∫—É–±–∫–æ–≤", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞ + 10 –º–µ—á–µ–π"
    ],
    "–ë—É–¥–µ—Ç –ª–∏ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –≤ –∑–∞–≥–∞–¥–∞–Ω–Ω—ã–π —Å—Ä–æ–∫ –ø–æ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–æ–π –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–µ?": [
        "–î–∞", "–ù–µ—Ç"
    ],
    "–ö—Ç–æ –∏–∑ —Ä—ã—Ü–∞—Ä–µ–π —Å–∞–º—ã–π —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π?": [
        "–†—ã—Ü–∞—Ä—å –∫—É–±–∫–æ–≤", "–†—ã—Ü–∞—Ä—å –∂–µ–∑–ª–æ–≤", "–†—ã—Ü–∞—Ä—å –º–µ—á–µ–π", "–†—ã—Ü–∞—Ä—å –ø–µ–Ω—Ç–∞–∫–ª–µ–π"
    ],
    "–ö–∞–∫–∞—è –∏–∑ –∫–æ—Ä–æ–ª–µ–≤ –Ω–∞–∏–±–æ–ª–µ–µ —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∞—è?": [
        "–ö–æ—Ä–æ–ª–µ–≤–∞ –ø–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –∂–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –∫—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –º–µ—á–µ–π"
    ],
    "–ö–∞–∫–∞—è –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–æ–∫ —É–∫–∞–∂–µ—Ç –Ω–∞ –∏–∑–º–µ–Ω—É?": [
        "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ + –¥–≤–æ–π–∫–∞ –∫—É–±–∫–æ–≤", "–¢—É–∑ –∫—É–±–∫–æ–≤ + —Ç—É–∑ –∂–µ–∑–ª–æ–≤", "–î—å—è–≤–æ–ª + –ø—è—Ç–µ—Ä–∫–∞ –º–µ—á–µ–π"
    ],
    "–ù–∞ –ø–µ—Ä–µ–µ–∑–¥ —É–∫–∞–∂–µ—Ç": [
        "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "–¢—É–∑ –ø–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—Ä–æ–π–∫–∞ –ø–µ–Ω—Ç–∞–∫–ª–µ–π"
    ],
    "–ù–∞ –¥–µ–≤–∏—á–Ω–∏–∫ —É–∫–∞–∂–µ—Ç": [
        "–¢—É–∑ –º–µ—á–µ–π", "–¢—Ä–æ–π–∫–∞ –ø–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—Ä–æ–π–∫–∞ –∫—É–±–∫–æ–≤"
    ]
}

quiz_answers = (None, 1, 0, 0, 1, 2, 1, 0, 1, 2, 0, 2)


@dp.message_handler(commands="start")
async def start(message: types.Message):
    id = message.from_id
    answer = (
        f"*–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é!* üå∏\n\n"
        f"–†–∞–¥–∞ –≤–∞—à–µ–º—É –∏–Ω—Ç–µ—Ä–µ—Å—É –∫ –¢–∞—Ä–æ! –ü—Ä–∏–≥–ª–∞—à–∞—é –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –≤–µ–±–∏–Ω–∞—Ä ¬´–û–±—É—á–µ–Ω–∏–µ –¢–∞—Ä–æ. –°–∏—Å—Ç–µ–º–∞ –†–∞–π–¥–µ—Ä–∞ –£—ç–π—Ç–∞¬ª.\n\n"
        f"*–í–µ–±–∏–Ω–∞—Ä —Å–æ—Å—Ç–æ–∏—Ç—Å—è 23 –º–∞—Ä—Ç–∞ –≤ 20:00 –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏*\n"
        f"_–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —ç—Ç–æ—Ç —á–∞—Ç –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –µ–≥–æ –Ω–∞—á–∞–ª–∞_\n\n"
        f"–ù–∞ –≤–µ–±–∏–Ω–∞—Ä–µ —è —Ä–∞—Å—Å–∫–∞–∂—É:\n"
        f"‚Ä¢ –≤—ã–±–æ—Ä –∫–æ–ª–æ–¥—ã üé¥\n"
        f"‚Ä¢ –æ—Ç–ª–∏—á–∏–µ —Å–∏—Å—Ç–µ–º —Ç–∞—Ä–æ –∏ –∫–æ–ª–æ–¥ üßê\n"
        f"‚Ä¢ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Å—Ç–∏—Ç—å –∫–æ–ª–æ–¥—ã üî•\n"
        f"‚Ä¢ –∫–∞–∫ –≤–µ—Ä–Ω–æ —á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—ã  üìñ\n"
        f"‚Ä¢ –∑–∞—á–µ–º –Ω—É–∂–Ω—ã –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—ã–µ –∫–∞—Ä—Ç—ã –∏ –Ω—É–∂–Ω—ã –ª–∏? üåö\n"
        f"‚Ä¢ –≥–¥–µ –∏—Å–∫–∞—Ç—å –ø–µ—Ä–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ üí∞\n"
        f"‚Ä¢ –ø–æ–¥–µ–ª—é—Å—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –Ω–∞—Ä–∞–±–æ—Ç–∫–∞–º–∏ üßô\n"
        f"‚Ä¢ –ø—Ä–æ–≤–µ–¥—ë–º –º–µ–¥–∏—Ç–∞—Ü–∏—é –Ω–∞ –ê—Ä–∫–∞–Ω —Ç–∞—Ä–æ üßò‚Äç‚ôÄÔ∏è\n\n"
        f"–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Å–∏—Å—Ç–µ–º–∞ –£—ç–π—Ç–∞?\n"
        f"–î–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏–∫–æ–π –∏ –æ–±—É—á–∏–≤—à–∏—Å—å –Ω–∞ —ç—Ç–æ–π –∫–æ–ª–æ–¥–µ, "
        f"–≤–∞–º –±—É–¥–µ—Ç –ª–µ–≥–∫–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∫–æ–ª–æ–¥–∞–º–∏.\n\n"
        f"–°—Ç–∞–≤—å –±—É–¥–∏–ª—å–Ω–∏–∫ ‚è∞ –∏ –≥–æ—Ç–æ–≤—å—Å—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚úçÔ∏è, "
        f"–±—É–¥–µ—Ç –º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω–æ–≥–æ! –î–æ –≤—Å—Ç—Ä–µ—á–∏ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä–µ! üå∑\n\n"
        f"–î–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è –ø–∏—à–∏—Ç–µ –ø–æ –ª—é–±–æ–º—É –∏–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:\n\n"
        f"[Instagram](https://example.com)\n\n"
        f"[Telegram](https://t.me/test_borcheg_bot)\n\n"
    )

    if not bd.check_user_exist(id):
        bd.add_user(id)

    await bot.send_message(id, answer, parse_mode="Markdown", reply_markup=btn.menu_keyboard)


@dp.message_handler(filters.Regexp(regexp=r'(–†|—Ä)–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'))
async def registration(message: types.Message):
    id = message.from_id
    if bd.check_reg_status(id) == "Not registered":
        bd.set_reg_status(id, "Set name")
        await bot.send_message(id, "–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º")
    elif bd.check_reg_status(id) == "Registered":
        await bot.send_message(
            id,
            f"–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –∏–º–µ–Ω–µ–º {bd.get_name(id)}\n–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ?",
            reply_markup=btn.change_reg_keyboard
        )


@dp.message_handler()
async def bot_message(message: types.Message):
    id = message.from_id
    answer = (
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä! üëç\n"
        f"–ñ–¥—É —Ç–µ–±—è 23 –º–∞—Ä—Ç–∞ –≤ 20:00!\n"
        f"_–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —ç—Ç–æ—Ç —á–∞—Ç –∏ –Ω–∞ –ø–æ—á—Ç—É –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –µ–≥–æ –Ω–∞—á–∞–ª–∞, –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏!_"
    )
    if bd.check_reg_status(id) == "Set name":
        if len(message.text) > 50:
            await message.reply("–ò–º—è –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤!")
        else:
            bd.set_name(id, message.text)
            bd.set_reg_status(id, "Set email")
            await bot.send_message(id, "–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é –ø–æ—á—Ç—É")

    elif bd.check_reg_status(id) == "Set email":
        if len(message.text) > 50 or "@" not in message.text:
            await message.reply("–ü–æ—á—Ç–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–º–≤–æ–ª '@' –∏ –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤!")
        else:
            bd.set_email(id, message.text)
            bd.set_reg_status(id, "Verification")
            await bot.send_message(
                id,
                f"–í–∞—à–µ –∏–º—è: {bd.get_name(id)}\n–í–∞—à–∞ –ø–æ—á—Ç–∞: {bd.get_email(id)}",
                reply_markup=btn.verification_keyboard
            )

    elif bd.check_reg_status(id) == "Verification" and message.text == '–î–∞ ‚úÖ':
        bd.set_reg_status(id, "Registered")
        await bot.send_message(id, answer, parse_mode="Markdown")

    elif bd.check_reg_status(id) == "Verification" and message.text == '–ù–µ—Ç ‚ùå':
        bd.set_reg_status(id, "Not registered")
        await bot.send_message(
            id,
            f"–ß—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'",
            reply_markup=btn.menu_keyboard
        )

    elif bd.check_reg_status(id) == "Registered" and message.text == '–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ‚úç':
        bd.set_reg_status(id, "Set name")
        await bot.send_message(id, f"–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º")

    elif bd.check_reg_status(id) == "Registered" and message.text == '–û—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚úã':
        await bot.send_message(id, f"–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")

    else:
        await bot.send_message(id, f"–ù–µ –ø–æ–Ω–∏–º–∞—é")


if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)
